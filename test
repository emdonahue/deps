#!/bin/zsh

source $(dirname "$0")/deps >/dev/null

function assert() {
       if [[ "$2" != "$3" ]]; then
       	   echo "Failure: $1\n\tReceived: $2\n\tExpected: $3"
	   ERR=1
       fi
}

DEPS=$(realpath ./deps)
DIR=$(mktemp -d)
mkdir "$DIR/subdir"
trap "rm -rf $DIR" EXIT
cd "$DIR"

#init
"$DEPS" init
[[ -f Makefile ]]
assert 'init creation' $? 0
"$DEPS" init 2>/dev/null
assert 'init already exists' $? 1
rm -f Makefile

#set
"$DEPS" init
"$DEPS" set a <<< 'touch a'
assert 'set initial' "$(grep -EA1 '^a' Makefile)" "$(echo 'a: \n\ttouch a')"
"$DEPS" set a b <<< 'touch b'
assert 'set reset' "$(grep -EA1 '^a' Makefile)" "$(echo 'a: b\n\ttouch b')"
"$DEPS" unset a
assert 'unset' "$(grep -EA1 '^a' Makefile)" ''
rm -f Makefile

#rm
"$DEPS" init
"$DEPS" set a <<< 'touch a'
touch a
"$DEPS" rm a
[[ -f a ]]
assert 'rm recipe removed' "$(grep -EA1 '^a' Makefile)" ''
assert 'rm file removed' $? 0
rm -f Makefile

#mv
"$DEPS" init
touch a
"$DEPS" set a <<< 'touch a'
"$DEPS" mv a b
[[ -f b ]]
assert 'mv file' $? 0
assert 'mv recipe' "$(grep -EA1 '^b' Makefile)" "$(echo 'b: \n\ttouch b')"
touch subdir/a
"$DEPS" set subdir/a <<< 'touch subdir/a'
"$DEPS" mv subdir/a subdir/b
[[ -f subdir/b ]]
assert 'mv subdir file' $? 0
assert 'mv subdir recipe' "$(grep -EA1 '^subdir/b' Makefile)" "$(echo 'subdir/b: \n\ttouch subdir/b')"
rm -f b subdir/b Makefile

#add
"$DEPS" init
touch a
assert 'parse recipe' "$(parse_recipe 'b' 'cat a > b')" 'a'
print -S 'cat a > b'
"$DEPS" add b > /dev/null
assert 'add' "$(grep -EA1 '^b' Makefile)" "$(echo 'b: a\n\tcat a >| b')"
rm -f a Makefile

#comment
"$DEPS" init
"$DEPS" set a <<< 'touch a'
"$DEPS" comment a test comment
assert 'comment' "$("$DEPS" comment a)" 'test comment'
rm -f Makefile

[[ -z "$ERR" ]] && echo "All Tests Pass"
exit "$ERR"
